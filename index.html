<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¸”ë¡œê·¸ HTML ì—ë””í„° Pro Master (Offline-safe)</title>

  <!-- (ì„ íƒ) CodeMirror CDN: ë¡œë“œ ì‹¤íŒ¨í•´ë„ ì•±ì´ ì£½ì§€ ì•Šë„ë¡ í´ë°± ì²˜ë¦¬í•¨ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

  <style>
    :root{
      --primary:#6366f1;
      --primary-glow: rgba(99,102,241,.35);
      --bg-dark:#0f172a;
      --bg-darker:#020617;
      --bg-light:#1e293b;
      --text-primary:#f1f5f9;
      --text-secondary:#cbd5e1;
      --border:#334155;
      --transition: all .25s cubic-bezier(.4,0,.2,1);
    }
    body.dark-mode{
      --bg-dark:#000;
      --bg-darker:#111;
      --bg-light:#222;
      --border:#444;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", "Malgun Gothic", sans-serif;
      background: linear-gradient(135deg, var(--bg-dark), var(--bg-darker));
      color: var(--text-primary);
      height:100vh; margin:0; overflow:hidden;
      display:flex; flex-direction:column;
    }

    /* Header */
    .header{
      background: rgba(15,23,42,.9);
      backdrop-filter: blur(12px);
      border-bottom: 2px solid var(--primary);
      padding: .65rem 1.1rem;
      box-shadow: 0 6px 28px rgba(0,0,0,.25);
      z-index:10;
    }
    .header-top{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:.55rem;}
    .header h1{
      margin:0;
      font-size:1.05rem; font-weight:900; letter-spacing:-.4px;
      background: linear-gradient(135deg, #818cf8, #c084fc, #f472b6);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    .btn{
      padding:.42rem .78rem;
      border:none; border-radius:10px;
      font-size:.8rem; font-weight:800;
      cursor:pointer; transition: var(--transition);
      display:inline-flex; align-items:center; justify-content:center;
      gap:.35rem;
      user-select:none;
    }
    .btn:hover:not(:disabled){
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 8px 18px rgba(0,0,0,.2);
    }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-success{ background:#10b981; color:#fff; }
    .btn-danger{ background:#ef4444; color:#fff; }
    .btn-secondary{ background: var(--bg-light); color: var(--text-primary); border:1px solid var(--border); }
    .btn-icon{ padding:.42rem; min-width:36px; font-size:1.05rem; }

    .toolbar{display:flex; align-items:center; flex-wrap:wrap; gap:8px;}
    .toolbar-group{
      display:flex; gap:2px; padding:2px;
      border-radius:12px;
      background: rgba(255,255,255,.06);
    }
    .separator{ width:1.5px; height:18px; background: var(--border); margin:0 .25rem; }

    /* Workspace */
    .workspace{ flex:1; display:flex; overflow:hidden; position:relative; }
    .pane{ display:flex; flex-direction:column; overflow:hidden; }
    .pane-header{
      background: var(--bg-darker);
      border-bottom:1px solid var(--border);
      padding:.45rem 1rem;
      display:flex; justify-content:space-between; align-items:center;
      font-size:.7rem; font-weight:900; letter-spacing:.08em;
      text-transform:uppercase; color: var(--text-secondary);
    }
    .zoom-box{
      display:flex; align-items:center; gap:.35rem;
      background: rgba(0,0,0,.3);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 8px; border-radius:10px;
    }
    .zoom-val{ min-width:44px; text-align:center; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.75rem; color:#e5e7eb; }

    #editor-pane{ width:50%; border-right:2px solid var(--border); }
    #preview-pane{ width:50%; background:#f8fafc; color:#111; }

    /* Fallback textarea editor */
    #plain-editor{
      width:100%; height:100%;
      border:0; outline:none;
      resize:none;
      padding:14px;
      font-size:14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      line-height:1.55;
      background:#ffffff; color:#111;
    }
    body.dark-mode #plain-editor{
      background:#0d1117; color:#c9d1d9;
    }

    /* CodeMirror height */
    .CodeMirror{ height:100% !important; font-size:14px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* Preview */
    .preview-content{ flex:1; overflow:auto; padding:2.2rem; background:#f1f5f9; }
    .preview-viewport{
      background:#fff;
      transform-origin: top center;
      transition: transform .25s;
      box-shadow: 0 20px 55px rgba(0,0,0,.14);
      border-radius:6px;
      overflow:hidden;
      position:relative;
      min-height:100%;
    }
    iframe#preview-frame{ width:100%; height:100%; border:none; display:block; }

    #resizer{ width:6px; background: var(--border); cursor: col-resize; z-index:5; transition:.15s; }
    #resizer:hover{ background: var(--primary); }

    /* Modal */
    .modal{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(10px);
      z-index:2000;
      justify-content:center; align-items:center;
    }
    .modal.active{ display:flex; }
    .modal-card{
      background: var(--bg-dark);
      border:1px solid var(--border);
      border-radius:20px;
      width:min(92vw, 720px);
      max-height:90vh;
      overflow:auto;
      padding:2.2rem;
      box-shadow: 0 32px 80px rgba(0,0,0,.6);
      position:relative;
    }
    .modal-close{
      position:absolute; top:1.2rem; right:1.2rem;
      border:none; background:none;
      color: var(--text-secondary);
      font-size:1.6rem; cursor:pointer;
      transition: var(--transition);
    }
    .modal-close:hover{ color: var(--primary); transform: scale(1.08); }

    .field{ margin-bottom: 1rem; }
    .field label{
      display:block; margin-bottom:.45rem;
      font-size:.8rem; font-weight:800; color: var(--text-secondary);
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding:.72rem .78rem;
      border:2px solid var(--border);
      border-radius:12px;
      background: var(--bg-darker);
      color: var(--text-primary);
      outline:none;
    }

    .theme-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap:10px;
      max-height: 420px;
      overflow:auto;
      padding:2px;
    }
    .theme-card{
      border:2px solid var(--border);
      border-radius:14px;
      background: var(--bg-darker);
      padding:.85rem;
      cursor:pointer;
      transition: var(--transition);
      text-align:center;
    }
    .theme-card.active{ border-color: var(--primary); background: rgba(99,102,241,.12); }
    .theme-dot{
      width:100%; height:10px; border-radius:10px;
      margin-bottom:8px;
    }
    .theme-name{ font-weight:900; font-size:.78rem; color: var(--text-primary); }

    #toast{
      position:fixed;
      left:50%; bottom:34px;
      transform: translateX(-50%) translateY(120px);
      background: var(--primary);
      color:#fff;
      padding: 12px 22px;
      border-radius:999px;
      font-weight:900;
      transition: transform .35s;
      z-index:9999;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    #toast.show{ transform: translateX(-50%) translateY(0); }

    .hint-badge{
      font-size:.72rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: var(--text-secondary);
      font-weight:800;
    }
  </style>
</head>

<body class="light-mode">
  <header class="header">
    <div class="header-top">
      <h1>ğŸ¨ Blog HTML Editor <span style="font-size:.78rem;opacity:.8;">PRO MASTER (Offline-safe)</span></h1>
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <span class="hint-badge" id="engine-badge">ì—ë””í„° ì—”ì§„: í™•ì¸ì¤‘...</span>
        <button class="btn btn-secondary btn-icon" id="dark-toggle" onclick="toggleDarkMode()">â˜€ï¸</button>
        <div class="separator"></div>
        <button class="btn btn-primary" onclick="copyHTML()">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
        <button class="btn btn-success" onclick="saveToLocal()">ğŸ’¾ ì €ì¥</button>
        <button class="btn btn-danger" onclick="resetEditor()">ğŸ”„ ë¦¬ì…‹</button>
        <button class="btn btn-danger" style="background:#dc2626;" onclick="clearCache()">ğŸ§¹ ìºì‹œì‚­ì œ</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-group">
        <button class="btn btn-secondary btn-icon" title="Undo" onclick="tryUndo()">âŸ²</button>
        <button class="btn btn-secondary btn-icon" title="Redo" onclick="tryRedo()">âŸ³</button>
      </div>
      <div class="separator"></div>
      <button class="btn btn-primary" onclick="openModal('themes')">ğŸŒˆ í…Œë§ˆ ê°¤ëŸ¬ë¦¬</button>
      <button class="btn btn-secondary" onclick="openModal('toc')">ğŸ“‘ ìë™ ëª©ì°¨</button>
      <div class="separator"></div>
      <div class="toolbar-group">
        <button class="btn btn-secondary btn-icon" title="Bold" onclick="wrapSelection('b')"><b>B</b></button>
        <button class="btn btn-secondary btn-icon" title="Underline" onclick="wrapSelection('u')"><u>U</u></button>
        <button class="btn btn-secondary btn-icon" title="Highlight" onclick="insHighlight()" style="color:#f1c40f;">ğŸ–ï¸</button>
      </div>
      <div class="separator"></div>
      <div class="toolbar-group">
        <button class="btn btn-secondary" onclick="openModal('h')">H#</button>
        <button class="btn btn-secondary" onclick="openModal('img')">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
        <button class="btn btn-secondary" onclick="openModal('cta')">âœ¨ ë²„íŠ¼</button>
        <button class="btn btn-secondary" onclick="openModal('br')">â†©ï¸ BR</button>
        <button class="btn btn-secondary btn-icon" title="Table" onclick="openModal('tbl')">â–¦</button>
      </div>
    </div>
  </header>

  <main class="workspace">
    <section class="pane" id="editor-pane">
      <div class="pane-header">
        <span>HTML Code</span>
        <div class="zoom-box">
          <button class="btn" style="padding:2px 8px;" onclick="adjustFont(-1)">-</button>
          <span class="zoom-val" id="font-size-val">14px</span>
          <button class="btn" style="padding:2px 8px;" onclick="adjustFont(1)">+</button>
        </div>
      </div>

      <!-- CodeMirror ìë¦¬(ë¡œë“œ ì„±ê³µ ì‹œ ì—¬ê¸°ë¡œ êµì²´ë¨) -->
      <textarea id="cm-textarea"></textarea>

      <!-- í´ë°± textarea (CodeMirror ì‹¤íŒ¨ ì‹œ í‘œì‹œ) -->
      <textarea id="plain-editor" style="display:none;"></textarea>
    </section>

    <div id="resizer"></div>

    <section class="pane" id="preview-pane">
      <div class="pane-header">
        <span>Preview</span>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="zoom-box">
            <button class="btn" style="padding:2px 8px;" onclick="adjustScale(-0.1)">-</button>
            <span class="zoom-val" id="scale-val">100%</span>
            <button class="btn" style="padding:2px 8px;" onclick="adjustScale(0.1)">+</button>
          </div>

          <div class="toolbar-group">
            <button class="btn btn-secondary btn-icon view-opt active" id="view-100" onclick="setVWidth('100%','100')">ğŸ–¥ï¸</button>
            <button class="btn btn-secondary btn-icon view-opt" id="view-768" onclick="setVWidth('768px','768')">ğŸ“±</button>
            <button class="btn btn-secondary btn-icon view-opt" id="view-375" onclick="setVWidth('375px','375')">ğŸ¤³</button>
          </div>
        </div>
      </div>

      <div class="preview-content">
        <div class="preview-viewport" id="viewport">
          <iframe id="preview-frame"></iframe>
        </div>
      </div>
    </section>
  </main>

  <div id="toast">OK</div>

  <!-- í…Œë§ˆ ëª¨ë‹¬ -->
  <div class="modal" id="modal-themes">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('themes')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">ğŸŒˆ í…Œë§ˆ ê°¤ëŸ¬ë¦¬</h2>
      <div class="theme-grid" id="theme-grid"></div>
      <div style="margin-top:1.2rem;">
        <button class="btn btn-secondary" style="width:100%;" onclick="closeModal('themes')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ëª©ì°¨ ëª¨ë‹¬ -->
  <div class="modal" id="modal-toc">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('toc')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">ğŸ“‘ ëª©ì°¨ ìƒì„±</h2>
      <div class="field">
        <label>ìŠ¤íƒ€ì¼</label>
        <select id="toc-style">
          <option value="box">Modern Box</option>
          <option value="list">Minimal List</option>
        </select>
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="generateTOC()">ìƒì„± ë° ì‚½ì…</button>
    </div>
  </div>

  <!-- ì œëª© ëª¨ë‹¬ -->
  <div class="modal" id="modal-h">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('h')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">ì œëª© ì‚½ì…</h2>
      <div class="field">
        <label>ë ˆë²¨</label>
        <select id="h-lv">
          <option value="2">H2</option>
          <option value="3">H3</option>
        </select>
      </div>
      <div class="field">
        <label>ë‚´ìš©</label>
        <input type="text" id="h-txt" placeholder="ì œëª©ì„ ì…ë ¥">
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="insH()">ì‚½ì…</button>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
  <div class="modal" id="modal-img">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('img')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">ì´ë¯¸ì§€ ì‚½ì…</h2>

      <div class="field">
        <label>ì´ë¯¸ì§€ URL</label>
        <input type="text" id="img-url" placeholder="https://...">
      </div>
      <div class="field">
        <label>Alt ì„¤ëª…</label>
        <input type="text" id="img-alt" value="ì´ë¯¸ì§€">
      </div>
      <div class="field">
        <label>ë„ˆë¹„(%)</label>
        <input type="number" id="img-w" value="100" min="20" max="100">
      </div>

      <button class="btn btn-primary" style="width:100%;" onclick="insImg()">ì‚½ì…</button>
    </div>
  </div>

  <!-- CTA ëª¨ë‹¬ -->
  <div class="modal" id="modal-cta">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('cta')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">âœ¨ ë²„íŠ¼ ìƒì„±</h2>

      <div class="field">
        <label>ë²„íŠ¼ í…ìŠ¤íŠ¸</label>
        <input type="text" id="cta-txt" value="ë²„íŠ¼ í´ë¦­í•˜ê¸° ğŸ‘‰">
      </div>
      <div class="field">
        <label>ë§í¬ URL</label>
        <input type="url" id="cta-url" placeholder="https://example.com">
      </div>
      <div class="field">
        <label>ë°°ê²½ìƒ‰</label>
        <input type="text" id="cta-bg" value="#6366f1" maxlength="7">
      </div>
      <div class="field">
        <label>ê¸€ììƒ‰</label>
        <input type="text" id="cta-fg" value="#ffffff" maxlength="7">
      </div>

      <button class="btn btn-primary" style="width:100%;" onclick="insCTA()">ì‚½ì…</button>
    </div>
  </div>

  <!-- BR ëª¨ë‹¬ -->
  <div class="modal" id="modal-br">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('br')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">ì¤„ë°”ê¿ˆ</h2>
      <div class="field">
        <label>ê°œìˆ˜</label>
        <select id="br-cnt">
          <option value="2">2ì¤„</option>
          <option value="1">1ì¤„</option>
        </select>
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="insBR()">ì‚½ì…</button>
    </div>
  </div>

  <!-- í…Œì´ë¸” ëª¨ë‹¬ -->
  <div class="modal" id="modal-tbl">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal('tbl')">Ã—</button>
      <h2 style="margin:0 0 1.2rem 0; color: var(--primary);">í…Œì´ë¸”</h2>
      <div style="display:flex; gap:10px;">
        <input class="field" type="number" id="tbl-r" value="3" min="1" placeholder="í–‰" style="flex:1;">
        <input class="field" type="number" id="tbl-c" value="2" min="1" placeholder="ì—´" style="flex:1;">
      </div>
      <button class="btn btn-primary" style="width:100%; margin-top:1rem;" onclick="insTbl()">ì‚½ì…</button>
    </div>
  </div>

  <!-- CodeMirror scripts (ì˜µì…˜). ì‹¤íŒ¨í•´ë„ í´ë°±ë¡œì§ì´ ìˆì–´ì„œ ì•±ì€ ì •ìƒ ë™ì‘ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    const THEMES = [
      { n:'ì—ë©”ë„ë“œ', h2:'#2ecc71', h3:'#27ae60', m:'#E8F5E9', c:'linear-gradient(135deg,#10b981,#2ecc71)' },
      { n:'ì˜¤ì…˜ë¸”ë£¨', h2:'#3498db', h3:'#2980b9', m:'#e3f2fd', c:'linear-gradient(135deg,#3498db,#2c3e50)' },
      { n:'ì„ ì…‹ë¡œì¦ˆ', h2:'#e91e63', h3:'#c2185b', m:'#fce4ec', c:'linear-gradient(135deg,#ff4081,#c2185b)' },
      { n:'ë¡œì–„í¼í”Œ', h2:'#9b59b6', h3:'#8e44ad', m:'#f3e5f5', c:'linear-gradient(135deg,#8e44ad,#34495e)' },
      { n:'ë”¥ì˜¤ë Œì§€', h2:'#e67e22', h3:'#d35400', m:'#fff3e0', c:'linear-gradient(135deg,#e67e22,#2c3e50)' },
      { n:'ê³¨ë“œì²´ì¸', h2:'#f1c40f', h3:'#f39c12', m:'#fef9e7', c:'linear-gradient(135deg,#111827,#f59e0b)' },
      { n:'ì°¨ì½œë…¸ì•„', h2:'#34495e', h3:'#2c3e50', m:'#ebf5fb', c:'linear-gradient(135deg,#64748b,#111827)' },
      { n:'ë„¤ì˜¨ì‚¬ì´ë²„', h2:'#00ffcc', h3:'#00d4aa', m:'#e0fff9', c:'linear-gradient(135deg,#6600ff,#00ffcc)' },
      { n:'ë ˆë“œì™€ì¸', h2:'#c0392b', h3:'#96281b', m:'#f9ebea', c:'linear-gradient(135deg,#c0392b,#2c3e50)' },
      { n:'ì¸ë””ê³ ', h2:'#4834d4', h3:'#686de0', m:'#ededff', c:'linear-gradient(135deg,#4834d4,#686de0)' }
    ];

    let state = {
      font: parseInt(localStorage.getItem('f') || '14', 10),
      scale: parseFloat(localStorage.getItem('s') || '1'),
      dark: localStorage.getItem('d') === 'true',
      v: localStorage.getItem('v') || '100',
      t: parseInt(localStorage.getItem('t') || '0', 10)
    };

    // Editor engine
    let editorEngine = 'plain'; // 'codemirror' or 'plain'
    let cm = null;
    const cmTextarea = document.getElementById('cm-textarea');
    const plain = document.getElementById('plain-editor');

    function setEngineBadge(){
      const badge = document.getElementById('engine-badge');
      badge.textContent = editorEngine === 'codemirror' ? 'ì—ë””í„° ì—”ì§„: CodeMirror' : 'ì—ë””í„° ì—”ì§„: ë‚´ì¥(í´ë°±)';
    }

    function getValue(){
      return editorEngine === 'codemirror' ? cm.getValue() : plain.value;
    }
    function setValue(v){
      if(editorEngine === 'codemirror') cm.setValue(v);
      else plain.value = v;
    }
    function focusEditor(){
      if(editorEngine === 'codemirror') cm.focus();
      else plain.focus();
    }

    function initEditor(){
      const defaultContent = localStorage.getItem('c') || getDefault();
      // CodeMirrorê°€ ì¡´ì¬í•˜ê³ (ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì„±ê³µ) ì •ìƒ ìƒì„± ê°€ëŠ¥í•˜ë©´ ì‚¬ìš©
      if(window.CodeMirror){
        try{
          cm = CodeMirror.fromTextArea(cmTextarea, {
            mode:'htmlmixed',
            theme: state.dark ? 'monokai' : 'default',
            lineNumbers:true,
            lineWrapping:true,
            indentUnit:2,
            tabSize:2,
            matchBrackets:true,
            extraKeys: { 'Ctrl-Z':'undo', 'Ctrl-Y':'redo' }
          });
          editorEngine = 'codemirror';
          setValue(defaultContent);
          cm.on('change', debounce(() => {
            render();
            localStorage.setItem('c', getValue());
          }, 350));
          setTimeout(()=>cm.refresh(), 0);
        }catch(e){
          // ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë‚˜ë©´ í´ë°±
          editorEngine = 'plain';
        }
      }

      if(editorEngine === 'plain'){
        // í´ë°± textarea í‘œì‹œ
        cmTextarea.style.display = 'none';
        plain.style.display = 'block';
        plain.value = defaultContent;

        // íƒ­ ì…ë ¥(ë“¤ì—¬ì“°ê¸°) ì§€ì›
        plain.addEventListener('keydown', (e) => {
          if(e.key === 'Tab'){
            e.preventDefault();
            const start = plain.selectionStart;
            const end = plain.selectionEnd;
            const insert = '  ';
            plain.value = plain.value.substring(0, start) + insert + plain.value.substring(end);
            plain.selectionStart = plain.selectionEnd = start + insert.length;
            scheduleRenderSave();
          }
        });

        plain.addEventListener('input', scheduleRenderSave);
      }

      setEngineBadge();
    }

    const scheduleRenderSave = debounce(() => {
      render();
      localStorage.setItem('c', getValue());
    }, 350);

    function debounce(fn, wait){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), wait);
      };
    }

    function apply(){
      document.body.classList.toggle('dark-mode', state.dark);
      document.getElementById('dark-toggle').textContent = state.dark ? 'â˜€ï¸' : 'ğŸŒ™';

      document.getElementById('font-size-val').textContent = state.font + 'px';
      document.getElementById('scale-val').textContent = Math.round(state.scale * 100) + '%';

      // editor font size
      if(editorEngine === 'codemirror' && cm){
        document.querySelector('.CodeMirror').style.fontSize = state.font + 'px';
        cm.setOption('theme', state.dark ? 'monokai' : 'default');
      }else{
        plain.style.fontSize = state.font + 'px';
      }

      document.getElementById('viewport').style.transform = `scale(${state.scale})`;
      setVWidth(state.v === '100' ? '100%' : state.v + 'px', state.v);

      render();
    }

    function toggleDarkMode(){
      state.dark = !state.dark;
      localStorage.setItem('d', String(state.dark));
      apply();
    }

    function adjustFont(diff){
      state.font = Math.min(24, Math.max(12, state.font + diff));
      localStorage.setItem('f', String(state.font));
      apply();
    }

    function adjustScale(diff){
      state.scale = Math.min(2, Math.max(0.5, state.scale + diff));
      localStorage.setItem('s', String(state.scale));
      apply();
    }

    function setVWidth(width, mode){
      state.v = mode;
      localStorage.setItem('v', mode);
      document.getElementById('viewport').style.width = width;

      document.querySelectorAll('.view-opt')
        .forEach(btn => btn.classList.toggle('active', btn.id === 'view-' + mode));
    }

    function renderThemes(){
      const grid = document.getElementById('theme-grid');
      grid.innerHTML = '';
      THEMES.forEach((theme, index) => {
        const card = document.createElement('div');
        card.className = 'theme-card' + (index === state.t ? ' active' : '');
        card.innerHTML = `
          <div class="theme-dot" style="background:${theme.h2};"></div>
          <div class="theme-name">${theme.n}</div>
        `;
        card.onclick = () => {
          state.t = index;
          localStorage.setItem('t', String(index));
          renderThemes();
          render();
        };
        grid.appendChild(card);
      });
    }

    function render(){
      const frame = document.getElementById('preview-frame');
      const viewport = document.getElementById('viewport');
      const doc = frame.contentDocument;
      const code = getValue();
      const t = THEMES[state.t] || THEMES[0];

      const css = `
      <style>
        body{
          font-family: "Segoe UI", "Malgun Gothic", system-ui, sans-serif;
          line-height: 1.8;
          color: #333;
          margin: 0;
          padding: 25px;
          background: transparent;
        }
        .wrap{ max-width: 820px; margin: 0 auto; padding-bottom: 60px; }
        img{
          max-width:100%; height:auto;
          border-radius: 12px;
          display:block; margin: 25px auto;
          box-shadow: 0 6px 22px rgba(0,0,0,.12);
        }
        h2{
          color:${t.h2};
          border-bottom: 3px solid ${t.h2};
          padding-bottom: 10px;
          margin: 56px 0 24px 0;
          font-size: 1.65rem;
        }
        h3{
          color:${t.h3};
          margin: 34px 0 14px 0;
          font-size: 1.32rem;
          border-left: 5px solid ${t.h3};
          padding-left: 10px;
        }
        a{
          color:${t.h2};
          text-decoration:none;
          font-weight: 700;
        }
        .meta-box{
          background:${t.m};
          padding: 22px;
          border-radius: 12px;
          margin: 18px 0 34px 0;
          border: 1px solid rgba(0,0,0,.08);
        }
        .meta-desc-box{
          background:${t.m};
          border-left: 5px solid ${t.h2};
          padding: 18px 20px;
          margin: 18px 0 30px 0;
          border-radius: 12px;
          font-size: 14px;
          color:#374151;
        }
        .meta-desc-title{
          font-weight: 900;
          font-size: 12px;
          letter-spacing: .08em;
          text-transform: uppercase;
          color:${t.h3};
          margin-bottom: 6px;
        }
        .cta-btn{
          display:inline-flex;
          align-items:center; justify-content:center;
          width:100%;
          max-width:600px;
          background:${t.c};
          color:#fff !important;
          padding: 18px;
          border-radius: 44px;
          font-weight: 900;
          font-size: 18px;
          text-decoration:none !important;
          box-shadow: 0 12px 24px rgba(0,0,0,.15);
          transition: .25s;
          margin: 20px auto;
        }
        .cta-btn:hover{ transform: translateY(-4px); filter: brightness(1.05); }
        ${state.dark ? `
          body{ color:#e5e7eb; }
          .meta-box, .meta-desc-box{ background:#111827; color:#e5e7eb; border-color: rgba(255,255,255,.12); }
        ` : ''}
      </style>`;

      doc.open();
      doc.write(`${css}<body><div class="wrap">${code}</div></body>`);
      doc.close();

      // iframe ë†’ì´ ë™ê¸°í™”
      const syncHeight = () => {
        const h = doc.documentElement.scrollHeight;
        frame.style.height = h + 'px';
        viewport.style.height = ((h + 110) * state.scale) + 'px';
      };
      setTimeout(syncHeight, 60);

      if(doc.body && window.ResizeObserver){
        const ro = new ResizeObserver(syncHeight);
        ro.observe(doc.body);
      }
    }

    function openModal(id){ document.getElementById('modal-' + id).classList.add('active'); }
    function closeModal(id){ document.getElementById('modal-' + id).classList.remove('active'); }

    window.addEventListener('click', (e) => {
      if(e.target.classList.contains('modal')) e.target.classList.remove('active');
    });
    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
      }
    });

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1800);
    }

    function copyHTML(){
      navigator.clipboard.writeText(getValue()).then(()=>toast('Copied!'));
    }
    function saveToLocal(){
      localStorage.setItem('c', getValue());
      toast('Saved!');
    }
    function resetEditor(){
      if(!confirm('ë¦¬ì…‹í• ê¹Œìš”? ì‘ì„± ë‚´ìš©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
      localStorage.removeItem('c');
      setValue(getDefault());
      render();
    }
    function clearCache(){
      if(!confirm('ëª¨ë“  ì„¤ì •/ë‚´ìš©ì„ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      localStorage.clear();
      location.reload();
    }

    // Undo/Redo: CodeMirrorë©´ í˜¸ì¶œ, í´ë°±ì´ë©´ ë¸Œë¼ìš°ì € ê¸°ë³¸(í‚¤ë³´ë“œ Ctrl+Z/Y ê¶Œì¥)
    function tryUndo(){
      if(editorEngine === 'codemirror' && cm) cm.undo();
      else toast('í´ë°± ì—ë””í„°: Ctrl+Z ì‚¬ìš©');
    }
    function tryRedo(){
      if(editorEngine === 'codemirror' && cm) cm.redo();
      else toast('í´ë°± ì—ë””í„°: Ctrl+Y ì‚¬ìš©');
    }

    function insAt(text){
      if(editorEngine === 'codemirror' && cm){
        const cur = cm.getCursor();
        cm.replaceRange(text + '\n', cur);
        cm.focus();
      }else{
        const start = plain.selectionStart;
        const end = plain.selectionEnd;
        const before = plain.value.slice(0, start);
        const after = plain.value.slice(end);
        const insert = text + '\n';
        plain.value = before + insert + after;
        plain.selectionStart = plain.selectionEnd = start + insert.length;
        plain.focus();
      }
      scheduleRenderSave();
    }

    function wrapSelection(tag){
      const open = `<${tag}>`;
      const close = `</${tag}>`;

      if(editorEngine === 'codemirror' && cm){
        const sel = cm.getSelection();
        cm.replaceSelection(open + sel + close);
        if(!sel){
          const cur = cm.getCursor();
          cm.setCursor({ line: cur.line, ch: cur.ch - close.length });
        }
        cm.focus();
      }else{
        const start = plain.selectionStart;
        const end = plain.selectionEnd;
        const sel = plain.value.slice(start, end);
        const insert = open + sel + close;
        plain.value = plain.value.slice(0, start) + insert + plain.value.slice(end);
        if(!sel){
          plain.selectionStart = plain.selectionEnd = start + open.length;
        }else{
          plain.selectionStart = start;
          plain.selectionEnd = start + insert.length;
        }
        plain.focus();
      }
      scheduleRenderSave();
    }

    function insHighlight(){
      const open = '<span style="background-color:#fff3cd; padding:2px 6px; border-radius:8px;"><b>';
      const close = '</b></span>';
      if(editorEngine === 'codemirror' && cm){
        const sel = cm.getSelection();
        cm.replaceSelection(open + sel + close);
        if(!sel){
          const cur = cm.getCursor();
          cm.setCursor({ line: cur.line, ch: cur.ch - close.length });
        }
        cm.focus();
      }else{
        const start = plain.selectionStart;
        const end = plain.selectionEnd;
        const sel = plain.value.slice(start, end);
        const insert = open + sel + close;
        plain.value = plain.value.slice(0, start) + insert + plain.value.slice(end);
        plain.selectionStart = plain.selectionEnd = start + open.length;
        plain.focus();
      }
      scheduleRenderSave();
    }

    function insH(){
      const lv = document.getElementById('h-lv').value;
      const txt = document.getElementById('h-txt').value || 'ì œëª©';
      insAt(`<h${lv}>${txt}</h${lv}>`);
      closeModal('h');
    }

    function insImg(){
      const url = document.getElementById('img-url').value.trim();
      const alt = document.getElementById('img-alt').value.trim() || 'ì´ë¯¸ì§€';
      const w = Math.min(100, Math.max(20, parseInt(document.getElementById('img-w').value || '100', 10)));
      if(!url){ toast('ì´ë¯¸ì§€ URLì´ ë¹„ì—ˆì–´ìš”'); return; }
      insAt(`<img src="${url}" alt="${alt}" style="width:${w}%; height:auto;">`);
      closeModal('img');
    }

    function insCTA(){
      const txt = document.getElementById('cta-txt').value || 'ë²„íŠ¼';
      const url = document.getElementById('cta-url').value || '#';
      const bg = document.getElementById('cta-bg').value || '#6366f1';
      const fg = document.getElementById('cta-fg').value || '#ffffff';

      const html = `
<div style="text-align:center; margin: 26px 0;">
  <a href="${url}" class="cta-btn" style="background:${bg}; color:${fg} !important;">${txt}</a>
</div>`.trim();

      insAt(html);
      closeModal('cta');
    }

    function insBR(){
      const cnt = parseInt(document.getElementById('br-cnt').value, 10);
      insAt('<br>'.repeat(cnt));
      closeModal('br');
    }

    function insTbl(){
      const rows = Math.max(1, parseInt(document.getElementById('tbl-r').value || '3',10));
      const cols = Math.max(1, parseInt(document.getElementById('tbl-c').value || '2',10));
      let html = '<table><thead><tr>';
      for(let j=0;j<cols;j++) html += '<th>ì œëª©</th>';
      html += '</tr></thead><tbody>';
      for(let i=0;i<rows;i++){
        html += '<tr>';
        for(let j=0;j<cols;j++) html += '<td>ë‚´ìš©</td>';
        html += '</tr>';
      }
      html += '</tbody></table>';
      insAt(html);
      closeModal('tbl');
    }

    function generateTOC(){
      const doc = document.getElementById('preview-frame').contentDocument;
      const headings = doc.querySelectorAll('h2, h3');
      if(!headings.length){ toast('H2/H3ê°€ ì—†ì–´ìš”'); return; }

      let toc = '<div class="meta-box"><strong>ğŸ“‘ ëª©ì°¨</strong><br>';
      headings.forEach((h,i)=>{
        toc += `<a href="#s${i+1}" style="display:block;margin-top:6px;padding-left:${h.tagName==='H3'?'18px':'0'};">- ${h.innerText}</a>`;
      });
      toc += '</div>';

      // id ì‚½ì…ì€ ì›ë³¸ ì½”ë“œì—ì„œ ë‹¨ìˆœ ì¹˜í™˜(100% ì™„ë²½í•˜ì§„ ì•ŠìŒ)
      let content = getValue();
      headings.forEach((h,i)=>{
        const tag = `<${h.tagName.toLowerCase()}`;
        const re = new RegExp(tag + '(?![^>]*id=)', 'i');
        content = content.replace(re, `${tag} id="s${i+1}"`);
      });
      setValue(content);
      insAt(toc);
      closeModal('toc');
      toast('ëª©ì°¨ ì‚½ì…ë¨');
    }

    function setupResizer(){
      const resizer = document.getElementById('resizer');
      const left = document.getElementById('editor-pane');
      const right = document.getElementById('preview-pane');

      resizer.onmousedown = (e) => {
        const startX = e.clientX;
        const startW = left.offsetWidth;

        document.onmousemove = (me) => {
          const total = resizer.parentNode.offsetWidth;
          const diff = me.clientX - startX;
          const percent = (startW + diff) / total * 100;
          left.style.width = Math.max(25, Math.min(75, percent)) + '%';
          right.style.width = (100 - Math.max(25, Math.min(75, percent))) + '%';
          if(editorEngine === 'codemirror' && cm) cm.refresh();
        };

        document.onmouseup = () => {
          document.onmousemove = null;
          document.onmouseup = null;
          if(editorEngine === 'codemirror' && cm) cm.refresh();
        };
      };
    }

    function getDefault(){
      return `<div style="max-width: 820px; margin: 0 auto; line-height: 1.8; color: #333;">
  <div class="meta-desc-box">
    <div class="meta-desc-title">META DESCRIPTION</div>
    <p style="margin:0;">ì´ ì˜ì—­ì€ ë©”íƒ€ë””ìŠ¤í¬ë¦½ì…˜ ì˜ˆì‹œì…ë‹ˆë‹¤. í•µì‹¬ í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ 2~3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.</p>
  </div>

  <h2>ì—ë””í„° ì‚¬ìš©ë²•</h2>
  <p>ìƒë‹¨ íˆ´ë°”ì—ì„œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <h3>ì£¼ìš” ê¸°ëŠ¥</h3>
  <ul>
    <li>ğŸŒˆ í…Œë§ˆ ê°¤ëŸ¬ë¦¬(í…Œë§ˆ ìƒ‰ ì¦‰ì‹œ ë°˜ì˜)</li>
    <li>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚½ì…</li>
    <li>âœ¨ ë²„íŠ¼ ìƒì„±</li>
    <li>ğŸ“‘ ìë™ ëª©ì°¨</li>
    <li>ğŸ’¾ ë¡œì»¬ ì €ì¥/ë³µì‚¬</li>
  </ul>

  <div style="text-align:center; margin:34px 0;">
    <a href="https://example.com" class="cta-btn">ğŸ›’ ë²„íŠ¼ ì˜ˆì‹œ</a>
  </div>

  <h2>ì‹œì‘í•˜ê¸°</h2>
  <p>ì´ì œ ì´ ë‚´ìš©ì„ ì§€ìš°ê³  ììœ ë¡­ê²Œ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
</div>`;
    }

    function boot(){
      initEditor();
      renderThemes();
      setupResizer();
      apply();
      // ì´ˆê¸° ë Œë”
      render();
    }
    boot();
  </script>
</body>
</html>
